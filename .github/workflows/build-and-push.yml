name: Build & Deploy Video Streaming System

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    name: 🛠️ Build & Push to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v3

      - name: 🔑 Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: 🏗️ Build and Push Auth Service
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/auth-service:latest ./auth-service
          docker push ${{ secrets.DOCKER_USERNAME }}/auth-service:latest

      - name: 🏗️ Build and Push Upload Video Service
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/upload-video-service:latest ./upload-video-service
          docker push ${{ secrets.DOCKER_USERNAME }}/upload-video-service:latest

      - name: 🏗️ Build and Push Streaming Video Service
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/streaming-video-service:latest ./streaming-video-service
          docker push ${{ secrets.DOCKER_USERNAME }}/streaming-video-service:latest

      - name: 🏗️ Build and Push File System Service
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/file-system-service:latest ./file-system-service
          docker push ${{ secrets.DOCKER_USERNAME }}/file-system-service:latest

      - name: 🔐 Logout from Docker Hub
        run: docker logout

  deploy:
    name: 🚀 Deploy to Server
    runs-on: ubuntu-latest
    needs: [build-and-push]  # ✅ FIXED - Ensures deploy only runs AFTER build-and-push

    steps:
      - name: ⬇️ Checkout Repository
        uses: actions/checkout@v3

      - name: 🔄 Pull New Images & Restart Services
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem user@server <<EOF
            docker-compose pull
            docker-compose up -d --force-recreate
            docker system prune -f
          EOF
